<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>WebSocket | 电里</title>
    <meta name="description" content="dianligegege&#39;s blog">
    <link rel="stylesheet" href="/styles/home.css">
  <link rel="shortcut icon" href="/image/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.8bcf7c97.css" as="style"><link rel="preload" href="/assets/js/app.d5a41c15.js" as="script"><link rel="preload" href="/assets/js/2.6c2cab3f.js" as="script"><link rel="preload" href="/assets/js/14.a345a1e7.js" as="script"><link rel="prefetch" href="/assets/js/10.c1d40707.js"><link rel="prefetch" href="/assets/js/11.5bb66e7f.js"><link rel="prefetch" href="/assets/js/12.9344437f.js"><link rel="prefetch" href="/assets/js/13.e15bcc8a.js"><link rel="prefetch" href="/assets/js/15.49eb6595.js"><link rel="prefetch" href="/assets/js/3.9cf65e87.js"><link rel="prefetch" href="/assets/js/4.27efa767.js"><link rel="prefetch" href="/assets/js/5.4e21b82c.js"><link rel="prefetch" href="/assets/js/6.a6b7efbc.js"><link rel="prefetch" href="/assets/js/7.3c7ec089.js"><link rel="prefetch" href="/assets/js/8.cbe684bd.js"><link rel="prefetch" href="/assets/js/9.e850bcb0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8bcf7c97.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">电里</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文档" class="dropdown-title"><span class="title">文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/old/destructuringAssignment.html" class="nav-link">旧文章</a></li><li class="dropdown-item"><!----> <a href="/new/import-export.html" class="nav-link">新文章</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/dianligegege/my-blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文档" class="dropdown-title"><span class="title">文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/old/destructuringAssignment.html" class="nav-link">旧文章</a></li><li class="dropdown-item"><!----> <a href="/new/import-export.html" class="nav-link">新文章</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/dianligegege/my-blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>一些旧文章</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/old/destructuringAssignment.html" class="sidebar-link">解构赋值</a></li><li><a href="/old/objectExpend.html" class="sidebar-link">对象的扩展</a></li><li><a href="/old/class.html" class="sidebar-link">Class类</a></li><li><a href="/old/websocketBase.html" class="active sidebar-link">WebSocket基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/old/websocketBase.html#_1-websocket-协议的主要特点" class="sidebar-link">1. WebSocket 协议的主要特点</a></li><li class="sidebar-sub-header"><a href="/old/websocketBase.html#_2-握手" class="sidebar-link">2. 握手</a></li><li class="sidebar-sub-header"><a href="/old/websocketBase.html#_3-客户端的-api" class="sidebar-link">3. 客户端的 API</a></li><li class="sidebar-sub-header"><a href="/old/websocketBase.html#_4-websocket-服务端" class="sidebar-link">4. Websocket 服务端</a></li><li class="sidebar-sub-header"><a href="/old/websocketBase.html#_5-参考链接" class="sidebar-link">5. 参考链接</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="websocket"><a href="#websocket" class="header-anchor">#</a> WebSocket</h1> <p><code>WebSocket</code>，即 <code>Web</code> 浏览器与 <code>Web</code> 服务器之间全双工通信标准。其中，<code>WebSocket</code> 协议由 <code>IETF</code> 定为标准，<code>WebSocket API</code> 由 <code>W3C</code> 定为标准。
利用 <code>Ajax</code> 和 <code>Comet</code> 技术进行通信可以提升 <code>Web</code> 的浏览速度。但问题在于通信若使用 <code>HTTP</code> 协议，就无法彻底解决瓶颈问题。<code>WebSocket</code> 网络技术正是为解决这些问题而实现的一套新协议及 <code>API</code>。
一旦 <code>Web</code> 服务器与客户端之间建立起 <code>WebSocket</code> 协议的通信连接，之后所有的通信都依靠这个专用协议进行。通信过程中可互相发送 <code>JSON</code>、<code>XML</code>、<code>HTML</code> 或图片等任意格式的数据。
由于是建立在 <code>HTTP</code> 基础上的协议，因此连接的发起方仍是客户端，而一旦确立 <code>WebSocket</code> 通信连接，不论服务器还是客户端，任意一方都可直接向对方发送报文。</p> <h2 id="_1-websocket-协议的主要特点"><a href="#_1-websocket-协议的主要特点" class="header-anchor">#</a> 1. WebSocket 协议的主要特点</h2> <ul><li><p>推送功能
支持由服务器向客户端推送数据的推送功能。这样，服务器可直接发送数据，而不必等待客户端的请求。</p></li> <li><p>减少通信量
只要建立起 WebSocket 连接，就希望一直保持连接状态。和 HTTP 相比，不但每次连接时的总开销减少，而且由于 WebSocket 的首部信息很小，通信量也相应减少了。</p></li></ul> <h2 id="_2-握手"><a href="#_2-握手" class="header-anchor">#</a> 2. 握手</h2> <p>为了实现 <code>WebSocket</code> 通信，在 <code>HTTP</code> 连接建立之后，需要完成一次“握手”（<code>Handshaking</code>）的步骤。</p> <h3 id="_2-1-握手-请求"><a href="#_2-1-握手-请求" class="header-anchor">#</a> 2.1 握手 请求</h3> <p>为了实现 <code>WebSocket</code> 通信，需要用到 <code>HTTP</code> 的 <code>Upgrade</code> 首部字段，告知服务器通信协议发生改变，以达到握手的目的。</p> <div class="language-txt extra-class"><pre class="language-text"><code>GET /chat HTTP/1.1
Host: server.example.com
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
Sec-WebSocket-Extensions: permessage-deflate; client_max_window_bits
Origin: http://example.com
Sec-WebSocket-Protocol: chat, superchat
Sec-WebSocket-Version: 13
</code></pre></div><p><code>Sec-WebSocket-Key</code> 字段内记录着握手过程中必不可少的键值。<code>Sec-WebSocket-Protocol</code> 字段内记录使用的子协议。
子协议按 <code>WebSocket</code> 协议标准在连接分开使用时，定义那些连接的名称。</p> <p>注意: 常规 <code>HTTP</code> 状态码只能在握手之前使用。 握手成功后，使用一组不同的状态码。</p> <h3 id="_2-2-握手-响应"><a href="#_2-2-握手-响应" class="header-anchor">#</a> 2.2 握手 响应</h3> <p>对于之前的请求，返回状态码 101 Switching Protocols 的响应。</p> <div class="language-txt extra-class"><pre class="language-text"><code>HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=
Sec-WebSocket-Protocol: chat
</code></pre></div><p><code>Sec-WebSocket-Accept</code> 参数需要服务器通过客户端发送的 <code>Sec-WebSocket-Key</code> 计算出来。 怎样计算呢， 把客户发送的 <code>Sec-WebSocket-Key</code> 和 &quot;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot; (这个叫做 &quot;魔法值&quot;)连接起来，把结果用 <code>SHA-1</code> 编码，再用 <code>base64</code> 编码一次，就可以了。</p> <p>所以如果 <code>Sec-WebSocket-Key</code> 是“dGhlIHNhbXBsZSBub25jZQ==”，<code>Sec-WebSocket-Accept</code> 将是“s3pPLMBiTxaQ9kYGzzhZRbK+xOo=”。 一旦服务器发送这个请求头，握手就完成了，你可以开始交换数据！成功握手确立 <code>WebSocket</code> 连接之后，通信时不再使用 <code>HTTP</code> 的数据帧，而采用 <code>WebSocket</code> 独立的数据帧。</p> <p><img src="https://note.youdao.com/yws/api/personal/file/WEB147ae81b64117aef54b7361687871eb1?method=download&amp;shareKey=cb1550a2140e7e8e543dc345f4019811" alt="WebSocket 通信"></p> <h2 id="_3-客户端的-api"><a href="#_3-客户端的-api" class="header-anchor">#</a> 3. 客户端的 API</h2> <h3 id="_3-1-构造函数"><a href="#_3-1-构造函数" class="header-anchor">#</a> 3.1 构造函数</h3> <p><code>WebSocket(url[,prorocols])</code>
返回一个 <code>WebSocket</code> 对象</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">var</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">'ws://localhost:3000/test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>执行上面语句之后，客户端就会与服务器进行连接。</p> <h3 id="_3-2-属性"><a href="#_3-2-属性" class="header-anchor">#</a> 3.2 属性</h3> <ul><li><p>WebSocket.readyState</p> <p>返回当前 <code>WebSocket</code> 的链接状态，只读。</p> <div class="language-txt extra-class"><pre class="language-text"><code>0 (CONNECTING)
正在链接中
1 (OPEN)
已经链接并且可以通讯
2 (CLOSING)
连接正在关闭
3 (CLOSED)
连接已关闭或者没有链接成功
</code></pre></div></li> <li><p>webSocket.onopen</p> <p><code>WebSocket.onopen</code> 属性定义一个事件处理程序，当 <code>WebSocket</code> 的连接状态 <code>readyState</code> 变为“OPEN”时调用;这意味着当前连接已经准备好发送和接受数据。这个事件处理程序通过 事件（建立连接时）触发。</p> <div class="language-js extra-class"><pre class="language-js"><code>ws<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hello Server!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>webSocket.onclose</p> <p><code>WebSocket.onclose</code> 属性定义一个事件处理程序，当 <code>WebSocket</code> 的连接状态 <code>readyState</code> 变为“CLOSED”时调用;它接收一个名字为“close”的 <code>CloseEvent</code> 事件。</p> <div class="language-js extra-class"><pre class="language-js"><code>ws<span class="token punctuation">.</span><span class="token function-variable function">onclose</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">var</span> code <span class="token operator">=</span> event<span class="token punctuation">.</span>code<span class="token punctuation">;</span>
<span class="token keyword">var</span> reason <span class="token operator">=</span> event<span class="token punctuation">.</span>reason<span class="token punctuation">;</span>
<span class="token keyword">var</span> wasClean <span class="token operator">=</span> event<span class="token punctuation">.</span>wasClean<span class="token punctuation">;</span>
<span class="token comment">// handle close event</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>webSocket.onmessage</p> <p><code>WebSocket.onmessage</code> 属性返回一事件监听器，当从服务器收到一条消息时，该监听器将被调用。该监听器接受一命名为 <code>message</code> 的 <code>MessageEvent</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code>ws<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> data <span class="token operator">=</span> event<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    <span class="token comment">// 处理数据</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>webSocket.binaryType</p> <p><code>WebSocket.binaryType</code> 返回 <code>websocket</code> 连接所传输二进制数据的类型。</p> <p>返回值：
1. <code>&quot;blob&quot;</code>  如果传输的是 <code>Blob</code> 类型的数据
2. <code>&quot;arraybuffer&quot;</code>  如果传输的是 <code>ArrayBuffer</code> 类型的数据。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> binaryType <span class="token operator">=</span> ws<span class="token punctuation">.</span>binaryType
</code></pre></div></li> <li><p>webSocket.bufferedAmount</p> <p><code>WebSocket.bufferedAmount</code> 是一个只读属性，用于返回已经被 <code>send()</code> 方法放入队列中但还没有被发送到网络中的数据的字节数。一旦队列中的所有数据被发送至网络，则该属性值将被重置为 0。但是，若在发送过程中连接被关闭，则属性值不会重置为 0。如果你不断地调用 <code>send()</code>，则该属性值会持续增长，它可以用来判断发送是否结束。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">10000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
socket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>socket<span class="token punctuation">.</span>bufferedAmount <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 发送完毕</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token comment">// 发送还没结束</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>webSocket.onerror</p> <p><code>WebSocket.onerror</code> 属性中，你可以定义一个发生错误时执行的回调函数，此事件的事件名为&quot;error&quot;。</p> <div class="language-js extra-class"><pre class="language-js"><code>socket<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// handle error event</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></li></ul> <h3 id="_3-3-方法"><a href="#_3-3-方法" class="header-anchor">#</a> 3.3 方法</h3> <ul><li><p>webSocket.send()</p> <p><code>WebSocket.onmessage</code> 属性返回一事件监听器，当从服务器收到一条消息时，该监听器将被调用。该监听器接受一命名为 <code>message</code> 的 <code>MessageEvent</code>。</p> <p>传输数据 <code>data</code> 的类型：</p> <ol><li><code>USVString</code> 文本字符串。字符串将以 UTF-8 格式添加到缓冲区，并且 <code>bufferedAmount</code> 将加上该字符串以 <code>UTF-8</code> 格式编码时的字节数的值。</li> <li><code>ArrayBuffer</code>  可以使用一有类型的数组对象发送底层二进制数据；其二进制数据内存将被缓存于缓冲区，<code>bufferedAmount</code> 将加上所需字节数的值。</li> <li><code>Blob</code> <code>Blob</code> 类型将队列 <code>blob</code> 中的原始数据以二进制中传输。 <code>bufferedAmount</code> 将加上原始数据的字节数的值。</li> <li><code>ArrayBufferView</code>  可以以二进制帧的形式发送任何 <code>JavaScript</code> 类数组对象 ；其二进制数据内容将被队列于缓冲区中。值 <code>bufferedAmount</code> 将加上必要字节数的值。</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>ws<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> data <span class="token operator">=</span> event<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    <span class="token comment">// 处理数据</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 发送Blob对象的例子</span>
<span class="token keyword">var</span> file <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#some'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>webSocket.close()</p> <p><code>WebSocket.onerror</code> 方法关闭 <code>WebSocket</code>  连接或连接尝试（如果有的话）。 如果连接已经关闭,则此方法不执行任何操作。</p> <p>参数：</p> <ol><li><code>code</code> 可选，一个数字状态码，它解释了连接关闭的原因。如果没有传这个参数，默认使用 1005。</li> <li><code>reason</code> 可选，一个人类可读的字符串，它解释了连接关闭的原因。这个 <code>UTF-8</code> 编码的字符串不能超过 123 个字节。</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>ws<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></li></ul> <h3 id="_3-4-实例"><a href="#_3-4-实例" class="header-anchor">#</a> 3.4 实例</h3> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>JAVASCRIPT:jsre()<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>发送信息到ws服务器<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>JAVASCRIPT:sendBinary()<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>请求二进制信息到ws服务器<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>JAVASCRIPT:ws.close()<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>关闭ws链接<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>some<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>some<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>JAVASCRIPT:sendpic()<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>发送Blob对象<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">

    <span class="token keyword">var</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">'ws://localhost:3000/test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ws.readyState'</span> <span class="token operator">+</span> ws<span class="token punctuation">.</span>readyState<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">jsre</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ws.readyState'</span> <span class="token operator">+</span> ws<span class="token punctuation">.</span>readyState<span class="token punctuation">)</span><span class="token punctuation">;</span>

        ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Hello,发送给服务端的信息'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 关闭ws链接</span>
    ws<span class="token punctuation">.</span><span class="token function-variable function">onclose</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ws.readyState'</span><span class="token operator">+</span> ws<span class="token punctuation">.</span>readyState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'关闭链接'</span><span class="token punctuation">,</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// .onmessage 用于指定收到服务器数据后的回调函数</span>
    ws<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 返回的数据可能是字符串或二进制</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> event<span class="token punctuation">.</span>data <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;String&quot;</span> <span class="token operator">+</span> event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// .onopen,用于指定链接成功后的回调函数</span>
    ws<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'onopen'</span> <span class="token operator">+</span> <span class="token string">'ws.readyState'</span> <span class="token operator">+</span> ws<span class="token punctuation">.</span>readyState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 发送Blob对象</span>
    <span class="token keyword">function</span> <span class="token function">sendpic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> file <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#some'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> file<span class="token punctuation">)</span> <span class="token comment">// object</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ws<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="_4-websocket-服务端"><a href="#_4-websocket-服务端" class="header-anchor">#</a> 4. Websocket 服务端</h2> <p>使用 <code>Node.js</code> 搭建 <code>WebSocket</code> 服务器的常用包</p> <ol><li><a href="https://www.npmjs.com/package/websocket" target="_blank" rel="noopener noreferrer">websocket<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.npmjs.com/package/ws" target="_blank" rel="noopener noreferrer">ws<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ol> <p>使用 <code>ws</code> 构建服务器例子：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 导入WebSocket模块:</span>
<span class="token keyword">const</span> WebSocket <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ws'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 引用Server类:</span>
<span class="token keyword">const</span> WebSocketServer <span class="token operator">=</span> WebSocket<span class="token punctuation">.</span>Server<span class="token punctuation">;</span>

<span class="token comment">// 实例化:</span>
<span class="token keyword">const</span> wss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocketServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    port<span class="token punctuation">:</span> <span class="token number">3000</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

wss<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">ws</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">链接上 [SERVER] connection()</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'服务端收到信息'</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 发送二进制数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>message <span class="token operator">===</span> <span class="token string">'binary'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">服务端收到请求二进制的数据 [SERVER] Received: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> array1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> array1<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                array1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// var blob = new Blob(['{name: &quot;blob&quot;}'],{type: 'application/json'});</span>
            <span class="token comment">// ws.send(blob);</span>
            ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>array1<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">服务端收到信息为字符串 [SERVER] Received: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">服务端发送信息 ECHO: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[SERVER] error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="_5-参考链接"><a href="#_5-参考链接" class="header-anchor">#</a> 5. 参考链接</h2> <p>[ 1 ] <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WebSocket" target="_blank" rel="noopener noreferrer">MDN web docs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>[ 2 ] <a href="http://www.ruanyifeng.com/blog/2017/05/websocket.html" target="_blank" rel="noopener noreferrer">WebSocket 教程 阮一峰<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>[ 3 ] <a href="https://www.liaoxuefeng.com/wiki/001434446689867b27157e896e74d51a89c25cc8b43bdb3000/001472780997905c8f293615c5a42eab058b6dc29936a5c000" target="_blank" rel="noopener noreferrer">WebSocket 廖雪峰<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>[ 4 ] <a href="https://book.douban.com/subject/25863515/" target="_blank" rel="noopener noreferrer">图解HTTP<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新时间:</span> <span class="time">10/29/2019, 12:27:47 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/old/class.html" class="prev">Class类</a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d5a41c15.js" defer></script><script src="/assets/js/2.6c2cab3f.js" defer></script><script src="/assets/js/14.a345a1e7.js" defer></script>
  </body>
</html>
